<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="csrf-token" content="{{csrfToken}}">
  <link rel="stylesheet" href="./styles/changepassword.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@100..900&family=Rubik:ital,wght@0,300..900;1,300..900&display=swap" rel="stylesheet" />
  <title>Change Password</title>
</head>
<body class="outfit">
  <div>
    <p class="logo">Campus<span>C</span>onnect</p>

    <form id="changePasswordForm" action="/profile/change-password" method="post" novalidate>
      <input type="password" placeholder="Old Password" name="old_password" id="oldPassword" required />
      <input type="password" placeholder="New Password" name="new_password" id="newPassword" required />
      <input type="password" placeholder="Confirm New Password" name="confirm_new_password" id="confirmPassword" required />

      <div id="strengthMeter" class="strength-meter">
        <p class="strength-title">Password Strength</p>
        <div class="strength-bar-container">
          <div id="strengthBar" class="strength-bar"></div>
        </div>
        <p id="strengthText"></p>
      </div>

      <div id="formMessages" role="status" aria-live="polite" style="min-height:1.3em;"></div>

      <button type="submit" id="submitBtn"><p>Update Password</p></button>
    </form>

    <div class="back-link">
      <p><a href="/profile">Back to Profile</a></p>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('changePasswordForm');
      const oldPasswordInput = document.getElementById('oldPassword');
      const newPasswordInput = document.getElementById('newPassword');
      const confirmPasswordInput = document.getElementById('confirmPassword');
      const strengthBar = document.getElementById('strengthBar');
      const strengthText = document.getElementById('strengthText');
      const messages = document.getElementById('formMessages');
      const submitBtn = document.getElementById('submitBtn');

      const getCsrfToken = () => {
        const meta = document.querySelector('meta[name="csrf-token"]');
        return meta ? meta.getAttribute('content') : null;
      };

      const checkPasswordStrength = (password) => {
        let strength = 0;
        if (password.match(/[A-Z]/)) strength++;
        if (password.match(/[0-9]/)) strength++;
        if (password.match(/[^A-Za-z0-9]/)) strength++;
        return strength;
      };

      const updateStrengthUI = (strength) => {
        let color = '#444';
        let text = '';
        let width = 0;

        if (strength === 1) {
          color = '#ff4d4d';
          text = 'Weak';
          width = 33;
        } else if (strength === 2) {
          color = '#ffa500';
          text = 'Medium';
          width = 66;
        } else if (strength === 3) {
          color = '#2B9900';
          text = 'Strong';
          width = 100;
        } else {
          color = '#444';
          text = '';
          width = 0;
        }

        strengthBar.style.width = `${width}%`;
        strengthBar.style.backgroundColor = color;
        strengthText.textContent = text;
        strengthText.style.color = color;
      };

      newPasswordInput.addEventListener('input', () => {
        const password = newPasswordInput.value;
        const strength = checkPasswordStrength(password);
        updateStrengthUI(strength);
      });

      updateStrengthUI(0);

      const showMessage = (msg, type = 'info') => {
        messages.textContent = msg;
        messages.style.color = (type === 'error') ? '#b00020' : (type === 'success' ? '#0b6623' : '#333');
      };

      const setLoading = (isLoading) => {
        submitBtn.disabled = isLoading;
        submitBtn.style.opacity = isLoading ? 0.7 : 1;
      };

      form.addEventListener('submit', async (event) => {
        event.preventDefault();

        const oldPassword = oldPasswordInput.value.trim();
        const newPassword = newPasswordInput.value.trim();
        const confirmPassword = confirmPasswordInput.value.trim();
        const strength = checkPasswordStrength(newPassword);

        if (!oldPassword || !newPassword || !confirmPassword) {
          showMessage('Please fill all fields.', 'error');
          return;
        }

        if (newPassword !== confirmPassword) {
          showMessage('New passwords do not match!', 'error');
          return;
        }

        if (strength < 3) {
          showMessage('Password must include: 1 uppercase, 1 number, 1 special character.', 'error');
          return;
        }

        const payload = {
          old_password: oldPassword,
          new_password: newPassword,
          confirm_new_password: confirmPassword
        };

        const csrf = getCsrfToken();

        try {
          setLoading(true);
          showMessage('Updating password...', 'info');

          const response = await fetch(form.action || '/profile/change-password', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              ...(csrf ? { 'X-CSRF-Token': csrf } : {})
            },
            credentials: 'include', 
            body: JSON.stringify(payload)
          });

          const data = await response.json().catch(() => null);

          if (response.ok) {
            const successMsg = (data && data.message) ? data.message : 'Password updated successfully.';
            showMessage(successMsg, 'success');

            oldPasswordInput.value = '';
            newPasswordInput.value = '';
            confirmPasswordInput.value = '';
            updateStrengthUI(0);
          } else {
            const errorMsg = (data && data.message) ? data.message : `Failed to update password (status ${response.status}).`;
            showMessage(errorMsg, 'error');
          }
        } catch (err) {
          console.error('Network/error:', err);
          showMessage('Network error. Please try again.', 'error');
        } finally {
          setLoading(false);
        }
      });

    });
  </script>
</body>
</html>
