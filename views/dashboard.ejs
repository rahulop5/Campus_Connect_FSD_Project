<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./styles/Dashboard.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@100..900&family=Rubik:ital,wght@0,300..900;1,300..900&display=swap" rel="stylesheet">
    <title>Student Dashboard</title>
</head>

<body class="outfit">
    <%- include("header.ejs") %>
    <%- include("sidebar.ejs") %>

    <div id="dashboard-container">
        <div class="db_mainpage">
            <div class="db_mainmain">
                <p>Welcome <%= name %></p>

                <div class="db_clubs">
                    <div class="db_banners">
                        <img src="./assets/abhisarga_banner.png" alt="">
                    </div>
                    <div class="db_date">
                        <p class="db_dateblack"><%= dayOfWeek %></p>
                        <p><%= day %></p>
                        <p class="db_dateblack"><%= month %>, <%= year %></p>
                    </div>                      
                </div>

                <div class="db_attengrade">
                    <% courses.forEach((course, index) => { %>
                        <% if (index < 3) { %>
                            <div class="db_subject">
                                <div class="db_grade">
                                    <p><%= course.subject %></p>
                                    <p>Predicted Grade</p>
                                    <p><%= course.grade.predgrade %> <span>A</span> B C D P F</p>
                                </div>
                                <div class="db_attendance">
                                    <p>Attendance</p>
                                    <div class="progress-container">
                                        <svg width="100" height="100">
                                            <circle cx="50" cy="50" r="40" class="background-circle"></circle>
                                            <circle cx="50" cy="50" r="40" class="progress-ring progress-circle" id="progress-ring-<%= index %>"></circle>
                                        </svg>
                                        <div class="progress-text" id="progress-text-<%= index %>"><%= course.attendancePercentage %>%</div>
                                    </div>
                                </div>
                            </div>
                        <% } %>
                    <% }) %>
                </div>
                  
                <div class="db_topq">
                    <p>Top Questions of the Week</p>
                    <div>
                        <% for (var i = 0; i < Math.min(3, questions.length); i++) { %>
                            <div class="problem">
                                <div class="votes">
                                    <p><%= questions[i].votes %> votes</p>
                                    <p><%= questions[i].answers.length %> answers</p>
                                    <p><%= questions[i].views %> views</p>
                                </div>
                                <div class="main">
                                    <h4><%= questions[i].heading %></h4>
                                    <p><%= questions[i].desc.slice(0, 100) %>...</p>
                                    <div class="tags">
                                        <% questions[i].tags.forEach(tag => { %>
                                            <div><p><%= tag %></p></div>
                                        <% }) %>
                                    </div>
                                </div>
                                <div class="user">
                                    <div class="useruser">
                                        <img src="./assets/duck_with_A_gun 1.png" alt="">
                                        <p><%= questions[i].asker.name %></p>
                                    </div>
                                </div>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>

            <div class="db_notice">
                <div class="po_noticeboard">
                    <p>Notice!</p>
                    <hr class="noticeline">
                    <div class="po_noticenews">
                        <div>
                            <img src="/assets/pin.png" alt="">
                            <p>Abhisarga night concert ticket sale is now live!</p>
                        </div>
                        <div>
                            <img src="/assets/pin.png" alt="">
                            <p>Recharge Point now has Burgers because of a certain someone!</p>
                        </div>
                        <div>
                            <img src="/assets/pin.png" alt="">
                            <p>Enigma, E-Cell, TedX are new Trend Setters!</p>
                        </div>
                    </div>
                    <hr class="noticeline">
                    <div class="po_noticenews">
                        <div>
                            <img src="/assets/premium.png" alt="">
                            <p>Campus Connect now brings you Premium at Rupees 1000 ONLY!</p>
                        </div>
                        <div>
                            <img src="/assets/premium.png" alt="">
                            <p>Get 30% OFF using student id verification!</p>
                        </div>
                        <div>
                            <img src="/assets/premium.png" alt="">
                            <p>Campus Connect now can track your attendance for you!</p>
                        </div>
                    </div>
                </div>
                <div class="ads">
                    <p>Ads Come Here</p>   
                </div>
            </div>
        </div>
    </div>

    <script>
        function setProgress(percent, index) {
            const circle = document.getElementById(`progress-ring-${index}`);
            const text = document.getElementById(`progress-text-${index}`);
            if (!circle || !text) return;
            const radius = 40;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference * (1 - percent / 100);
            circle.style.strokeDasharray = `${circumference}`;
            circle.style.strokeDashoffset = offset;
            text.innerText = `${percent}%`;
        }

        <% courses.forEach((course, index) => { %>
            setProgress(<%= course.attendancePercentage %>, <%= index %>);
        <% }) %>

        async function loadDashboardPartial() {
            try {
                const res = await fetch("/student/dashboard/partial");
                if (!res.ok) throw new Error("Failed to fetch dashboard");
                const html = await res.text();
                document.getElementById("dashboard-container").innerHTML = html;
            } catch (err) {
                console.error(err);
            }
        }
        
        loadDashboardPartial();
        setInterval(loadDashboardPartial, 30000);
    </script>
</body>
</html>
