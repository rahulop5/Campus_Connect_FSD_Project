<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./styles/profile.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@100..900&family=Rubik:ital,wght@0,300..900;1,300..900&display=swap" rel="stylesheet">
    <title>Document</title>
</head>
<body>
    <script>
        function makeEditable(imgElement) {
            const inputBox = imgElement.closest('.auth_a').querySelector('.editable-input');
            const field = inputBox.getAttribute('name');
            const imageDiv = imgElement.closest('.image_div');

            if (imgElement.src.includes("edit-text")) {
                if (field === 'password') {
                    window.location.href = '/changepassword';
                    return;
                }
                imgElement.src = "./assets/check.png";
                imageDiv.classList.add('is-checkmark');
                inputBox.removeAttribute('readonly');
                inputBox.classList.add('editing');
                inputBox.focus();
            } else if (imgElement.src.includes("check")) {
                const newValue = inputBox.value;
                if (field === 'phone') {
                    const phoneRegex = /^\d{10}$/;
                    if (!phoneRegex.test(newValue)) {
                        alert("Please enter a valid 10-digit phone number.");
                        return;
                    }
                }
                imgElement.src = "./assets/edit-text 2.png";
                imageDiv.classList.remove('is-checkmark');
                inputBox.setAttribute('readonly', true);
                inputBox.classList.remove('editing');

                fetch('/profile/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ field, value: newValue })
                })
                .then(response => {
                    if (!response.ok) throw new Error("Failed to update");
                    return response.text();
                })
                .then(data => console.log("Success:", data))
                .catch(err => console.error("Error updating:", err));
            }
        }
    </script>
    
    <form id="bodbod">
        <div>
            <div id="my_profile1" class="my_profile">
                M Y
            </div>
    
            <div id="my_profile2" class="my_profile">
                P R O F I L E
            </div>
        </div>
        <div>
            <div class="auth_qa" id="first_auth">
                <div class="auth_q">Name</div>
                <div class="auth_a">
                    <div><input type="text" name="name" value="<%= student.name %>" readonly class="editable-input" /></div>
                    <div class="image_div"><img class="edit_mark" src="./assets/edit-text 2.png" alt="edit name" onclick="makeEditable(this)"></div>
                </div>    
            </div>
            <div class="auth_qa" id="second_auth">
                <div class="auth_q">Email</div>
                <div class="auth_a"><div><%= student.email %></div></div>    
            </div>
            <div class="auth_qa" id="third_auth">
                <div class="auth_q">Password</div>
                <div class="auth_a">
                    <div><input type="text" name="password" value="••••••••••••••••••" readonly class="editable-input" /></div>
                    <div class="image_div"><img class="edit_mark" src="./assets/edit-text 2.png" alt="edit password" onclick="makeEditable(this)"></div>
                </div>    
            </div>
            <div class="auth_qa" id="fourth_auth">
                <div class="auth_q">Phone Number</div>
                <div class="auth_a">
                    <div><input type="text" name="phone" value="<%= student.phone %>" readonly class="editable-input" /></div>
                    <div class="image_div"><img class="edit_mark" src="./assets/edit-text 2.png" alt="edit phone" onclick="makeEditable(this)"></div>
                </div>    
            </div>
            <div class="auth_qa" id="fifth_auth">
                <div class="auth_q">Roll Number</div>
                <div class="auth_a"><div><%= student.roll %></div></div>    
            </div>
            <div id="rb_row1">
                <div class="rb_r1_col">
                    <div class="rb_r1_q">Branch</div>
                    <div class="rb_r1_a"><%= student.branch %></div>
                </div>
                <div class="rb_r1_col">
                    <div class="rb_r1_q">Year</div>
                    <div class="rb_r1_a">UG<%= student.ug %></div>
                </div>
                <div class="rb_r1_col">
                    <div class="rb_r1_q">Section</div>
                    <div class="rb_r1_a"><%= student.section %></div>
                </div>
            </div>
            <div id="rb_row2">
                <div class="rb_r2_q">Courses Enrolled</div>
                <div id="rb_r2_course_r1">
                    <% if (student.courses && student.courses.length > 0) { %>
                        <% student.courses.forEach(course => { const shortform = course.course.name.split(" ").map(w => w[0].toUpperCase()).join(""); %>
                            <div><%= shortform %></div>
                        <% }); %>
                    <% } else { %>
                        <div>No courses enrolled</div>
                    <% } %>
                </div>
                <div id="rb_r2_course_r2">
                    <% if (student.additionalCourses && student.additionalCourses.length > 0) { %>
                        <% student.additionalCourses.forEach(course => { %>
                            <div><%= course.course?.name || 'Unnamed' %></div>
                        <% }); %>
                    <% } else { %>
                        <div>-</div>
                    <% } %>
                </div>
            </div>

            <div id="seperator_line"></div>
            <div id="l_row1">
                <div class="l_r1_col" id="l_r1_c1">
                    <div class="l_r1_col_q">Upvotes</div>
                    <div class="l_r1_col_aimg">
                        <div class="l_r1_col_a">103</div>
                        <div class="l_r1_col_img"><img src="./assets/arrow (1) 1.png" alt="upvote icon"></div>
                    </div>
                </div>
                <div class="l_r1_col" id="l_r1_c2">
                    <div class="l_r1_col_q">Echelons</div>
                    <div class="l_r1_col_aimg">
                        <div id="echelons_a" class="l_r1_col_a">72</div>
                        <div class="l_r1_col_img"><img src="./assets/star 1.png" alt="echelons icon"></div>
                    </div>
                </div>
            </div>
            <div id="l_row2">
                <div class="l_r2_col" id="l_r2_c1">
                    <div class="l_r2_col_q">Total Questions Asked</div>
                    <div class="l_r2_col_aimg"><div class="l_r2_col_a">23</div></div>
                </div>
                <div class="l_r2_col" id="l_r2_c2">
                    <div class="l_r2_col_q">Total Questions Answered</div>
                    <div class="l_r2_col_aimg"><div class="l_r2_col_a">19</div></div>
                </div>
            </div>
            
            <div class="pfp-container" id="pfpContainer">
                <input type="file" id="pfpFileInput" accept="image/*" hidden>
                <img id="profilePic" src="./assets/pfp 1.png" alt="Profile Picture">
                <div class="pfp-overlay">
                    <div class="pfp-btn" id="changeBtn"></div>
                    <div class="pfp-btn" id="deleteBtn"></div>
                    <div class="pfp-btn" id="addBtn"></div>
                </div>
            </div>

            <svg xmlns="http://www.w3.org/2000/svg" width="880" height="520" viewBox="0 0 880 520" fill="none">
                <foreignObject x="-4" y="-4" width="888" height="528"><div xmlns="http://www.w3.org/1999/xhtml" style="backdrop-filter:blur(2px);clip-path:url(#bgblur_0_646_878_clip_path);height:100%;width:100%"></div></foreignObject><g data-figma-bg-blur-radius="4">
                <mask id="path-1-inside-1_646_878" fill="white">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M880 40C880 17.9086 862.091 0 840 0H490C467.909 0 450 17.9086 450 40V230C450 252.091 432.091 270 410 270H40C17.9086 270 0 287.909 0 310V480C0 502.091 17.9086 520 40 520H840C862.091 520 880 502.091 880 480V270V40Z"/>
                </mask>
                <path fill-rule="evenodd" clip-rule="evenodd" d="M880 40C880 17.9086 862.091 0 840 0H490C467.909 0 450 17.9086 450 40V230C450 252.091 432.091 270 410 270H40C17.9086 270 0 287.909 0 310V480C0 502.091 17.9086 520 40 520H840C862.091 520 880 502.091 880 480V270V40Z" fill="#1F1F1F" fill-opacity="0.6"/>
                <path d="M490 1H840V-1H490V1ZM451 230V40H449V230H451ZM40 271H410V269H40V271ZM1 480V310H-1V480H1ZM840 519H40V521H840V519ZM879 270V480H881V270H879ZM879 40V270H881V40H879ZM840 521C862.644 521 881 502.644 881 480H879C879 501.539 861.539 519 840 519V521ZM-1 480C-1 502.644 17.3563 521 40 521V519C18.4609 519 1 501.539 1 480H-1ZM40 269C17.3563 269 -1 287.356 -1 310H1C1 288.461 18.4609 271 40 271V269ZM449 230C449 251.539 431.539 269 410 269V271C432.644 271 451 252.644 451 230H449ZM840 1C861.539 1 879 18.4609 879 40H881C881 17.3563 862.644 -1 840 -1V1ZM490 -1C467.356 -1 449 17.3563 449 40H451C451 18.4609 468.461 1 490 1V-1Z" fill="#373737" mask="url(#path-1-inside-1_646_878)"/>
                </g>
                <defs>
                <clipPath id="bgblur_0_646_878_clip_path" transform="translate(4 4)"><path fill-rule="evenodd" clip-rule="evenodd" d="M880 40C880 17.9086 862.091 0 840 0H490C467.909 0 450 17.9086 450 40V230C450 252.091 432.091 270 410 270H40C17.9086 270 0 287.909 0 310V480C0 502.091 17.9086 520 40 520H840C862.091 520 880 502.091 880 480V270V40Z"/>
                </clipPath></defs>
            </svg>
        </div>
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const pfpContainer = document.getElementById('pfpContainer');
            const profilePic = document.getElementById('profilePic');
            const pfpFileInput = document.getElementById('pfpFileInput');
            const changeBtn = document.getElementById('changeBtn');
            const deleteBtn = document.getElementById('deleteBtn');
            const addBtn = document.getElementById('addBtn');

            changeBtn.addEventListener('click', () => pfpFileInput.click());
            addBtn.addEventListener('click', () => pfpFileInput.click());
            deleteBtn.addEventListener('click', () => {
                pfpContainer.classList.add('no-image');
            });
            pfpFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        profilePic.src = e.target.result;
                        pfpContainer.classList.remove('no-image');
                    }
                    reader.readAsDataURL(file);
                }
            });
        });
    </script>
</body>
</html>