<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Question</title>
  <link rel="stylesheet" href="/styles/Problemopen.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@100..900&family=Rubik:wght@300..900&display=swap" rel="stylesheet" />
</head>

<body>
  <%- include("header.ejs") %>
  <%- include("sidebar.ejs") %>

  <div class="mainpage">
    <div class="toptop">
      <div class="top">
        <div class="searchques">
          <h1 class="outfit" id="questionHeading">Loading...</h1>
        </div>
      </div>
      <div class="po_qdetails outfit">
        <p id="viewsText">Viewed 0 times</p>
      </div>
      <div class="searchquesinput">
        <div class="outfit po_reward">
          <p id="rewardText">Loading reward...</p>
        </div>
        <div class="input-container">
          <div class="input">
            <form>
              <div class="advsearch">
                <input type="text" placeholder="Search a Question" />
                <button type="submit"><img src="/assets/search.png" alt="" /></button>
              </div>
            </form>
          </div>
          <div class="hidden-div">
            <p>Filters will go here</p>
          </div>
        </div>
        <div class="filter">
          <button><img src="/assets/filter (1).png" alt="" /></button>
        </div>
      </div>
    </div>

    <hr />

    <div class="po_main">
      <div class="po_question">
        <div class="po_qelab">
          <div class="updownvote">
            <div class="upvote-triangle" id="upvoteBtn"></div>
            <div class="po_qnoofvotes outfit"><p id="voteCount">0</p></div>
            <div class="downvote-triangle" id="downvoteBtn"></div>
            <div><img src="/assets/save.png" alt="" class="po_save" /></div>
          </div>

          <div class="po_qdesc outfit">
            <div><p id="questionDesc">Loading question...</p></div>
            <div class="po_qtags" id="tagsContainer"></div>
            <div class="po_user">
              <div class="po_useruser">
                <img src="/assets/duck_with_A_gun 1.png" alt="" />
                <p id="askerName">Loading...</p>
              </div>
            </div>
          </div>
        </div>

        <div class="outfit">
          <div class="po_ansheading">
            <p>Answers :</p>
          </div>
          <div id="answersContainer"></div>
        </div>

        <div class="outfit po_userans">
          <div class="po_useransheading"><p>Answer to the Question :</p></div>
          <div class="po_useranscontainer">
            <div class="po_useranstools">
              <img src="/assets/bold.png" alt="" />
              <img src="/assets/italic.png" alt="" />
              <img src="/assets/heading.png" alt="" />
              <img src="/assets/codeansbox.png" alt="" />
              <div id="submit-answer-btn" type="button"><p>Submit</p></div>
            </div>
            <textarea id="answer-textarea" class="po_useransbox"></textarea>
          </div>
        </div>
      </div>

      <div class="po_notice outfit">
        <div class="po_noticeboard">
          <p>Notice!</p>
          <hr class="noticeline" />
          <div class="po_noticenews">
            <div><img src="/assets/pin.png" alt="" /><p>Abhisarga night concert ticket sale is now live!</p></div>
            <div><img src="/assets/pin.png" alt="" /><p>Recharge Point now has Burgers because of a certain someone!</p></div>
            <div><img src="/assets/pin.png" alt="" /><p>Enigma , E-Cell , TedX are new Trend Setters!</p></div>
          </div>
          <hr class="noticeline" />
          <div class="po_noticenews">
            <div><img src="/assets/premium.png" alt="" /><p>Campus Connect Premium at ₹1000 ONLY!</p></div>
            <div><img src="/assets/premium.png" alt="" /><p>Get 30% OFF using student ID verification!</p></div>
            <div><img src="/assets/premium.png" alt="" /><p>Campus Connect can now track your attendance for you!</p></div>
          </div>
        </div>
        <div class="po_ads"><h1>Ads Come here</h1></div>
      </div>
    </div>
  </div>

  <!-- Template for Answer -->
  <template id="answerTemplate">
    <div class="po_anselab">
      <div class="ansupdownvote">
        <div class="upvote-triangle answerUpvote"></div>
        <div class="po_qnoofvotes outfit"><p class="answerVotes">0</p></div>
        <div class="downvote-triangle answerDownvote"></div>
      </div>
      <div class="po_ansdesc outfit">
        <p class="answerText"></p>
      </div>
    </div>
    <hr class="hr_answer" />
  </template>

  <script>
    async function loadQuestionDetails() {
      const pathParts = window.location.pathname.split("/");
      const questionId = pathParts[pathParts.length - 1];
      try {
        const res = await fetch(`/problemopen/${questionId}/partial`);
        if (!res.ok) throw new Error("Failed to fetch question details");

        const data = await res.json();
        const q = data.question;

        document.getElementById("questionHeading").textContent = q.heading;
        document.getElementById("viewsText").textContent = `Viewed ${q.views} times`;
        document.getElementById("rewardText").textContent = `A Reward of +${q.wealth} wealth is offered ✨`;
        document.getElementById("voteCount").textContent = q.votes;
        document.getElementById("questionDesc").textContent = q.desc;
        document.getElementById("askerName").textContent = q.asker?.name || "Anonymous";

        document.getElementById("upvoteBtn").dataset.id = q._id;
        document.getElementById("downvoteBtn").dataset.id = q._id;


        const tagsContainer = document.getElementById("tagsContainer");
        tagsContainer.innerHTML = "";
        (q.tags || []).forEach(tag => {
          const tagDiv = document.createElement("div");
          tagDiv.innerHTML = `<p>${tag}</p>`;
          tagsContainer.appendChild(tagDiv);
        });

        const answersContainer = document.getElementById("answersContainer");
        const template = document.getElementById("answerTemplate");
        answersContainer.innerHTML = "";
        (q.answers || []).forEach(a => {
          const clone = template.content.cloneNode(true);
          clone.querySelector(".answerVotes").textContent = a.votes || 0;
          clone.querySelector(".answerText").textContent = a.desc || "";
          clone.querySelector(".answerUpvote").dataset.questionId = q._id;
          clone.querySelector(".answerUpvote").dataset.answerId = a._id;
          clone.querySelector(".answerDownvote").dataset.questionId = q._id;
          clone.querySelector(".answerDownvote").dataset.answerId = a._id;
          answersContainer.appendChild(clone);
        });
      } catch (err) {
        console.error("Error loading question:", err);
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadQuestionDetails();

      document.getElementById("submit-answer-btn").addEventListener("click", async () => {
        const textarea = document.getElementById("answer-textarea");
        const text = textarea.value.trim();
        const questionId = window.location.pathname.split("/").pop();

        if (!text) return alert("Please type an answer!");

        try {
          const res = await fetch("/submit-answer", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ questionId, answerText: text }),
          });
          const data = await res.json();
          if (data.success) {
            textarea.value = "";
            loadQuestionDetails(); // Refresh the list after new answer
          } else alert("Failed to submit answer!");
        } catch (e) {
          console.error("Error submitting answer:", e);
        }
      });
    });
  </script>
  <script src="/scripts/problemopen.js"></script>
</body>
</html>
