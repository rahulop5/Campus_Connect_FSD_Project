<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/styles/Profdashboard.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;700&family=Outfit:wght@100..900&display=swap"
    rel="stylesheet" />
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <title>Dashboard</title>
</head>

<body class="outfit">
  <%- include("header.ejs") %>

    <div class="dashboard-wrapper">
      <p class="dashboard-title">Dashboard</p>

      <div class="welcome-text">
        <p>
          <span class="gradient-text">Welcome back,</span><br />
          <span class="prof-light">Dr.</span>
          <span class="prof-bold">
            <%= professor.name %>
          </span>
        </p>
      </div>

      <form id="marksUploadForm" class="marks-upload-form" action="/prof/submit" method="post" enctype="multipart/form-data">
        <div class="courses-selection-container">
          <p class="assigned-courses-title">Assigned Courses:</p>
          <div class="assigned-courses-box">
            <% if (courses.length > 0) { %>
              <% courses.forEach(course => { %>
                <label class="course-box-label">
                  <input type="radio" name="courseId" value="<%= course.id %>" class="hidden-radio">
                  <div class="course-box">
                    <div class="course-code">
                      <%= course.name %>
                    </div>
                    <div class="course-section">
                      <img src="/assets/section-icon.png" alt="Section" class="section-icon" />
                      <span>Sec-<%= course.section %></span>
                    </div>
                  </div>
                </label>
              <% }) %>
            <% } else { %>
              <p>No assigned courses available.</p>
            <% } %>
          </div>
        </div>

        <div class="upload-container">
          <p class="upload-title">Upload page:</p>
          <div class="upload-box-wrapper">
            <div class="upload-main-content">
              <div class="file-upload">
                <input type="file" name="marksheet" id="file" class="hidden-file" accept=".csv" />
                <label for="file" class="custom-file-label">
                  <div class="upload-content">
                    <div class="upload-icon"></div>
                    <div class="upload-text">
                      <p>Drag & drop files here</p>
                      <span>or</span>
                      <p class="browse-files">Browse files</p>
                    </div>
                  </div>
                </label>
              </div>
              <div class="csv-preview-container" id="csvPreviewContainer">
                <p class="preview-title">File Preview</p>
                <div class="csv-preview-table-wrapper" id="csvPreviewTable"></div>
              </div>
            </div>

            <div class="upload-footer">
              <div class="file-note-wrapper">
                <img src="/assets/warn7.png" alt="Warning" class="warning-icon" />
                <div class="note-text-content">
                  <p class="file-note">Note:</p>
                  <p class="file-note1">Only .csv supported</p>
                </div>
              </div>
              <button class="submit-btn" type="submit">
                <span class="submit-text">Submit</span>
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>

    <script>
      const uploadForm = document.getElementById('marksUploadForm');
      const fileInput = document.getElementById('file');
      const fileUploadLabel = document.querySelector('.custom-file-label');
      const uploadContent = document.querySelector('.upload-content');
      const csvPreviewContainer = document.getElementById('csvPreviewContainer');
      const csvPreviewTable = document.getElementById('csvPreviewTable');
      const originalUploadContentHTML = uploadContent.innerHTML;

      function removeFile() {
        fileInput.value = null;
        uploadContent.innerHTML = originalUploadContentHTML;
        csvPreviewTable.innerHTML = '';
        csvPreviewContainer.style.display = 'none';
        fileUploadLabel.classList.remove('file-uploaded');
      }

      function generatePreview(file) {
        const reader = new FileReader();
        reader.onload = function(event) {
          const csvContent = event.target.result;
          const rows = csvContent.trim().split('\n');
          if (rows.length === 0) return;
          let tableHTML = '<table><thead><tr>';
          const headers = rows[0].split(',');
          headers.forEach(header => { tableHTML += <th>${header.trim()}</th>; });
          tableHTML += '</tr></thead><tbody>';
          for (let i = 1; i < rows.length; i++) {
            const cells = rows[i].split(',');
            tableHTML += '<tr>';
            cells.forEach(cell => { tableHTML += <td>${cell.trim()}</td>; });
            tableHTML += '</tr>';
          }
          tableHTML += '</tbody></table>';
          csvPreviewTable.innerHTML = tableHTML;
          csvPreviewContainer.style.display = 'flex';
        };
        reader.readAsText(file);
      }

      function displayFile(file) {
        if (!file.name.endsWith('.csv')) {
          alert('Invalid file type. Please upload a .csv file.');
          removeFile();
          return;
        }
        fileUploadLabel.classList.add('file-uploaded');
        uploadContent.innerHTML = `
          <div class="file-uploaded-icon"></div>
          <div class="file-display">
            <p class="file-name" title="${file.name}">${file.name}</p>
            <span class="remove-file-btn" role="button" aria-label="Remove file"></span>
          </div>
        `;
        uploadContent.querySelector('.remove-file-btn').addEventListener('click', (e) => {
          e.stopPropagation();
          removeFile();
        });
        generatePreview(file);
      }

      fileUploadLabel.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileUploadLabel.classList.add('dragged-over');
      });
      fileUploadLabel.addEventListener('dragleave', () => {
        fileUploadLabel.classList.remove('dragged-over');
      });
      fileUploadLabel.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUploadLabel.classList.remove('dragged-over');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          fileInput.files = files;
          displayFile(files[0]);
        }
      });
      fileInput.addEventListener('change', () => {
        if (fileInput.files.length > 0) {
          displayFile(fileInput.files[0]);
        }
      });

      uploadForm.addEventListener('submit', function(event) {
        event.preventDefault();

        const formData = new FormData(uploadForm);

        fetch('/prof/submit', {
          method: 'POST',
          body: formData,
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return true; 
        })
        .then(success => {
          alert('Successfully done!');
          window.location.reload();
        })
        .catch(error => {
          console.error('There was a problem with the submission:', error);
          alert('An error occurred. Please try again.');
        });
      });
    </script>
</body>

</html>